# ElasticSearch

## 1:  课程简介

(1): 差别

6.X与7.X的差别非常大

(2): 为什么要用Elasticserch

- SQL中如果进行模糊查询：like%狂神说%，数据量少直接使用SQL中的查询没问题，但如果是大数据使用SQL就比较慢。此时我们就要引入Elasticsearch。
- Elasticsearch的作用就是搜索（百度，github,淘宝）。都使用了Elasticserach

(3): 学习路线

1. 聊一个人
2. 货比三家
3. 安装
4. 生态圈
5. 分词器ik
6. RestFul操作ES
7. CRUD
8. SpringBoot集成ElasticSearch(从原理分析)
9. 爬虫爬取数据
10. 实战，模拟全文检索

以后只要用到搜索，就可以使用ElasticSearch! (在大数据量的情况下使用！)

## 2：聊聊Lucene的创始人

 1：Elasticsearch就是对Lucene进行封装。Lucene 是一个用于文本搜索的函数库。Lucene是一套信息检索工具包！只是一个jar包，不包含搜索引擎系统。

2：Lucene包含索引结构，读写索引的工具。

3：ElasticSearch是基于Lucene做了一些封装和增强。

## 3：ElasticSearch概述

1. ElasticSearch，简称es, es是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储，检索数据；本身扩展性好，可以扩展到上百台服务器，处理PB级别（大数据时代）的数据。es也使用java开发并使用Lucene作为核心来实现所有的索引和搜索的功能，但是它的目的是通过简单的Restful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。
2. 谁在使用es
   - 维基百科
   - Stack Overflow
   - Github
   - 电商，招聘
   - 商品价格监控网站

## 4：Elasticsearch与solr的区别

1. 当单纯的对已有的数据进行搜索时，Solr更快。

   ![1654141504570](6_2.assets/1654141504570.png) 

2. 当实时建立索引时，solr会产生io阻塞，查询性能比较差，Elaticsearch具有明显的优势。

   ![1654141482509](6_2.assets/1654141482509.png)

3. 随着数据量的增加，Solr的搜索效率会变得更低。而Elasticserach却没有明显的变化。

   ![1654141449732](6_2.assets/1654141449732.png)

4. 总结

(1): es是开箱即用(解压就可以使用！), 非常简单。Solr安装略微复杂一丢丢

(2): Solr利用Zookeeper进行分布式管理。而ElasticSearch自身带有分布式协调管理功能。

(3): Solr支持更多格式的数据，比如JSON,XML,CSV,而ElasticSearch仅支持JSON格式

(4): Solr官方提供的功能更多，而ElasticSearch本身更注重核心功能，高级功能使用第三方插件来实现。例如图形化界面使用kibana来支撑。

(5): Solr查询更快，但更新索引之后就变慢了(也就是插入删除比较慢)，用于电商等查询多的应用。

- ES建立索引块，实时性查询快，用于facebook新浪等搜索
- Solr是传统搜索应用的有力解决方案，但ElasticSearch更适合于新兴的实时搜索应用

(6): Solr比较成熟，有一个更大的，更成熟的用户，开发和贡献者社区，而ElasticSearch相对开发维护者较少，更新太快，学习和使用成本较高。

## 5：ElasticSearch安装及Head插件安装

1：直接解压

![1654142505883](6_2.assets/1654142505883.png)

2：熟悉目录

```java
bin 启动文件
config 配置文件
  log4j2.properties 日志配置文件
  jvm.options java虚拟机相关的配置
  elasticsearch.yml elasticsearch的配置文件！默认是9200端口。
lib 相关jar包
logs 日志
modules 功能模块
plugins 插件（比如ik分词器插件）
```

3：启动elasticserach并访问：localhost:9200

![1654150435091](6_2.assets/1654150435091.png)

4: 安装可视化界面es head的插件

1. 下载启动

   ```java
   npm install
   npm run start 
   ```

2. 连接测试发现存在跨域问题(跨端口，跨网站，跨ip都叫跨域问题)

   ![1654155150535](6_2.assets/1654155150535.png)

   ```java
   //elasticsearch.yml文件中加入
   http.cors.enabled: true
   http.cors.allow-origin: "*"
   ```

3. 重启es服务器，然后再次连接

   ![1654155856449](6_2.assets/1654155856449.png)

   初学可以把es当作一个数据库！（可以建立索引，文档）

   >这个head我们就单纯的把它当作数据展示的工具！我们后面所有的查询，都使用kibana

   ## 6：kibana的安装

   1：ELK简介：

   - ELK：是ElasticSearch, Logstash, Kibana三大开源框架首字母大写简称。
   - ElasticSearch：是一个基于Lucene, 分布式，通过Restful进行交互的近实时搜索平台框架。类似百度，谷歌这种大数据全文搜索引擎的场景都可以使用ElasticSearch作为底层支持框架。
   - Logstash: 是ELK的中央数据流引擎，用于从不同目标（文件/数据存储/MQ）收集的不同格式的数据。经过过滤后支持输出到不同目的地（文件/MQ/redis/elasticsearch/kafka）。
   - kibana: 将elasticsearch的数据通过友好的页面展示出来，提供实时分析的功能。

   流程：
   ![1654156957998](6_2.assets/1654156957998.png)

   2：

   

   (1): 下载安装kibana

   ![1654157164875](6_2.assets/1654157164875.png)

​              (2): 启动测试

![1654157918644](6_2.assets/1654157918644.png)

(3): 访问http://localhost:5601

![1654157994995](6_2.assets/1654157994995.png)

(4): 开发工具

我们之后的所有操作都在都在左侧的小扳手里面编写！

(5): 汉化! 自己修改kibana的配置即可！zh-CN!

![1654158340029](6_2.assets/1654158340029.png)

![1654158398411](6_2.assets/1654158398411.png) 

## 7: ElasticSearch的核心

- 索引
- 字段类型(mapping)
- 文档
- 分片（倒排索引）

### 1: elasticsearch与关系型数据库mysql的对比：

![1654161139093](6_2.assets/1654161139093.png)

elasticsearch(集群)中可以包含多个索引（数据库），每个索引中可以包含多个类型（表），每个类型下又包含多个文档（行），每个文档中又包含多个字段（列）。

>es是面向文档的。它里面的一切都是JSON。

### 2：elsticsearch的物理设计

elasticsearch在后台把每个索引划分成多个分片，每个分片可以在集群中的不同服务器间迁移。一个es就是一个集群！默认集群的名字就是elasticsearch! 

### 3: elasticsearch的逻辑设计

​        一个索引类型中，包含多个文档，比如说文档1，文档2。当我们索引一片文档时，可以通过下面的顺序找到它：索引-->类型-->文档ID，通过这个组合我们就能索引到某个具体的文档。

注意：ID不必是个整数，它可以是一个字符串！

### 4：文档

之前说elasticsearch是面向文档的，那么就意味着索引和搜索数据的最小单位是文档，elasticsearch中，文档有几个重要属性：

- 自我包含：一篇文档同时包含字段和对应的值，也就是同时包含key:value!
- 可以是层次型的，一个文档中包含另外的文档，复杂的逻辑实体就是这样来的！
- 灵活的结构，文档不依赖于预先定义的模式，我们知道关系型数据库中，要提前定义字段才能使用，在elasticserach中，对于字段是非常灵活的。有时候，我们可以忽略该字段，或者动态的添加一个新的字段。

尽管我们可以随意的新增或忽略某个字段，但是，每个字段的类型非常重要。比如一个年龄字段的类型，可以是字符串也可以是整形。因为elasticsearch会保存字段和类型之间的映射。这种映射具体到每一个字段，因此在elasticsearch中，类型有时候也称为映射类型。

### 5：类型

类型是文档的逻辑容器，就像关系型数据库中一样，表格是行的容器。类型中对于字段的定义称为映射，比如name的映射为字符串类型。我们说文档是无模式的，它们不需要拥有映射中所定义的所有字段，比如新增一个字段，那么elasticsearch是怎么做到的呢？elasticsearch会自动将新字段加入映射，但是这个字段不确定它是什么类型，elasticsearch就开始猜，如果这个值是18，那么elasticsearch就会认为它是整形。但是elasticsearch也可能猜不对，所以最安全的方式就是提前定义好所需要的映射，这点根关系型数据库就殊途同归了，先定义好字段，然后再使用！

### 6：索引

1：就是数据库！

2：索引是映射类型的容器，elasticserach中的索引是一个非常大的文档集合。索引存储了映射类型的字段和其它设置。然后它们被存储到了各个分片上。接下来研究下分片是如何工作的。

3：一个集群至少有一个节点，而一个节点就是一个elasticsearch进程，节点可以有多个索引默认的，如果创建索引，那么索引将会有五个分片（primary shard，又称为主分片）构成，每一个主分片会有一个副本(replica shard，又称复制分片)

![1654164454630](6_2.assets/1654164454630.png)

上图是一个有三个节点的集群，可以看到主分片和对应的复制分片都不会在同一个节点内，这样做的好处是：如果某个节点挂掉了，数据也不至于丢失。实际上，一个分片就是一个Lucene索引，一个包含倒排索引的文件目录，倒排索引的结构使得elasticsearch在不扫描全部文档的情况下，就能告诉你哪些文档包含特定的关键字。

### 7：倒排索引

1: 简介

elasticsearch使用的是一种称为倒排索引的结构，采用Lucene的倒排索引作为底层，这种结构适用于快速的全文搜索，一个索引由文档中所有不重复的列表构成，对于每一个词，都有一个包含它的文档列表。例如，现在有两个文档，每个文档包含以下内容：

![1654164971709](6_2.assets/1654164971709.png)

为了创建倒排索引，我们首先要将每个文档拆分成独立的词（或称为词条或者tokens），然后创建一个包含所有不重复的词条的排序列表，然后列出每个词条出现在哪个文档：

![1654165205391](6_2.assets/1654165205391.png)

![1654165223742](6_2.assets/1654165223742.png)

两个文档都匹配，但是第一个文档比第二个文档的匹配程度更高。如果没有别的条件，现在这两个关键字的文档都将返回。

在这叫权重，后面称为分数score。

2:  示例二：
(1): 我们通过博客标签来搜索博客文章。那么倒排索引列表就是这样一个结构：

![1654165487022](6_2.assets/1654165487022.png)

如果要搜索含有python标签的文章，那相对于查找所有原始数据而言，查找倒排索引后的数据将会快的多。只需要查看标签这一栏，然后获取相关的文章ID即可。

(2): elasticsearch的索引和Lucene的索引对比

elasticsearch中，索引这个词被频繁使用，这就是术语的使用。在elasticsearch中，索引被分为对个分片，没份分片是一个Lucene的索引。所以一个elasticsearch索引就是由多个Lucene索引组成的。别问为什么，就是因为elasticsearch使用Lucene作为底层索引。

(3): 接下来的操作将在kibana中的Dev Tools的Console中完成。

